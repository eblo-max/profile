"""
Полная версия профайлера партнера - 28 вопросов в 6 блоках
Основано на техническом задании с научным обоснованием
"""

from typing import Dict, List, Any, Tuple
from app.utils.enums import UrgencyLevel


# =================================
# ЭКСПЕРИМЕНТАЛЬНЫЕ ВОПРОСЫ СО СВОБОДНОЙ ФОРМОЙ ОТВЕТОВ (все 28 вопросов)
# =================================

FREE_FORM_QUESTIONS = {
    # BLOCK 1: NARCISSISM (6 questions)
    "narcissism_q1": {
        "id": "narcissism_q1",
        "block": "narcissism",
        "weight": 3,
        "text": "Опишите конкретную ситуацию за последние 2 недели, когда вы высказали партнеру критическое замечание о его поведении или поступке.",
        "context": "Вспомните точный момент: что именно вы сказали, какой была его первая реакция в течение 10 секунд, как развивался разговор дальше, чем закончился.",
        "prompt_hints": [
            "Что конкретно вы сказали партнеру (точные слова)",
            "Какой была его мимика и жесты в первые секунды",
            "Как он отвечал словами на вашу критику",
            "Изменилось ли его поведение после разговора"
        ],
        "min_length": 50,
        "example": "На прошлой неделе я сказал партнеру, что он слишком громко разговаривает по телефону. Он сразу нахмурился, скрестил руки и сказал: 'Ты всегда придираешься к мелочам'. Потом начал перечислять мои недостатки. Разговор закончился тем, что он ушел в другую комнату, хлопнув дверью."
    },
    
    "narcissism_q2": {
        "id": "narcissism_q2", 
        "block": "narcissism",
        "weight": 3,
        "text": "Вспомните последний раз, когда у вас или ваших близких произошло что-то хорошее (повышение, успех, достижение). Опишите реакцию партнера в первые 5 минут после того, как он узнал новость.",
        "context": "Сосредоточьтесь на конкретных словах, жестах, выражении лица. Что он сказал первым? Как долго говорил о вашем успехе? Переводил ли разговор на себя?",
        "prompt_hints": [
            "Какими были его первые слова после новости",
            "Сколько времени он говорил именно о вашем успехе",
            "Упоминал ли он свои достижения в ответ",
            "Какие эмоции вы видели на его лице"
        ],
        "min_length": 50,
        "example": "Когда я рассказала о повышении, он сказал 'Это хорошо', но через 30 секунд начал говорить о своих проблемах на работе. Весь разговор свел к тому, что ему тяжелее, чем мне. Поздравил формально, без энтузиазма."
    },
    
    "narcissism_q3": {
        "id": "narcissism_q3",
        "block": "narcissism",
        "weight": 3, 
        "text": "Опишите ситуацию, когда партнер совершил ошибку или неудачно что-то сделал. Как именно он объяснял причины своей неудачи?",
        "context": "Вспомните конкретный случай: кого или что он винил, какие внешние факторы упоминал, признавал ли свою ответственность, какие слова использовал.",
        "prompt_hints": [
            "Кого конкретно он винил в своей неудаче",
            "Какие внешние обстоятельства упоминал",
            "Признавал ли он свою долю ответственности",
            "Какие именно слова использовал для объяснения"
        ],
        "min_length": 50,
        "example": "Когда он опоздал на важную встречу, обвинил пробки, 'идиотов на дороге', плохую навигацию. Сказал, что все против него сговорились. Ни слова о том, что выехал поздно или не проверил маршрут заранее."
    },
    
    "narcissism_q4": {
        "id": "narcissism_q4",
        "block": "narcissism", 
        "weight": 3,
        "text": "Вспомните разговор, когда вы рассказывали партнеру о своих переживаниях, проблемах или чувствах. Сколько времени он слушал, прежде чем начать говорить о себе?",
        "context": "Попробуйте вспомнить конкретную ситуацию за последний месяц. Засеките примерное время: сколько минут он слушал только вас, когда и как перевел разговор на себя.",
        "prompt_hints": [
            "Сколько времени он слушал, не прерывая",
            "Какими словами он перевел разговор на себя",
            "Задавал ли уточняющие вопросы о ваших чувствах",
            "Сравнивал ли ваши проблемы со своими"
        ],
        "min_length": 50,
        "example": "Рассказывала о конфликте с подругой. Он слушал минуты 2, потом сказал: 'А вот у меня на работе...' и полчаса говорил о своих проблемах. Мои чувства так и остались неуслышанными."
    },
    
    "narcissism_q5": {
        "id": "narcissism_q5",
        "block": "narcissism",
        "weight": 2,
        "text": "Опишите, как партнер рассказывает о своих достижениях другим людям в вашем присутствии. Какие слова использует, какие детали подчеркивает?",
        "context": "Вспомните конкретную ситуацию в компании друзей, на работе или в семье. Как он преподносит свои успехи, преувеличивает ли, упоминает ли вашу роль в его достижениях.",
        "prompt_hints": [
            "Какие именно слова он использует для описания успехов",
            "Преувеличивает ли он свою роль в достижениях",
            "Упоминает ли вклад других людей",
            "Как часто использует слова 'я', 'мне', 'мой'"
        ],
        "min_length": 50,
        "example": "На вечеринке рассказывал о проекте, который мы делали вместе. Говорил только 'я сделал', 'я придумал', 'я добился'. Мою помощь не упомянул ни разу, хотя я работала над этим наравне с ним."
    },
    
    "narcissism_q6": {
        "id": "narcissism_q6",
        "block": "narcissism",
        "weight": 3,
        "text": "Вспомните ситуацию, когда партнер получил обратную связь от коллег, друзей или семьи. Как он пересказывал вам эти комментарии?",
        "context": "Сосредоточьтесь на том, как он интерпретировал чужие слова: что добавлял от себя, что опускал, как объяснял негативные комментарии, как подавал позитивные.",
        "prompt_hints": [
            "Как он интерпретировал критические замечания",
            "Что добавлял к позитивным комментариям",
            "Искажал ли смысл сказанного другими",
            "Как объяснял мотивы людей, давших обратную связь"
        ],
        "min_length": 50,
        "example": "Начальник сказал ему 'неплохо, но можно лучше'. Он мне рассказал как 'начальник был в восторге от моей работы'. Критику представил как зависть коллег к его успехам."
    },
    
    # BLOCK 2: CONTROL (6 questions)
    "control_q1": {
        "id": "control_q1",
        "block": "control",
        "weight": 3,
        "text": "Вспомните последний раз, когда вы запланировали встречу с друзьями или личное мероприятие. Опишите реакцию партнера в момент, когда вы сообщили ему об этих планах.",
        "context": "Сосредоточьтесь на его первых словах, жестах, выражении лица. Пытался ли он изменить ваши планы? Какие аргументы использовал?",
        "prompt_hints": [
            "Что он сказал первым, когда узнал о ваших планах",
            "Какие причины привел, чтобы вы остались",
            "Какие эмоции проявил (раздражение, обида, злость)",
            "Удалось ли вам в итоге осуществить свои планы"
        ],
        "min_length": 50,
        "example": "Когда я сказала, что иду на день рождения к подруге, он сразу нахмурился и сказал: 'А как же наши планы на вечер?' Хотя никаких планов не было. Потом начал жаловаться на головную боль и говорить, что ему нужна моя поддержка."
    },
    
    "control_q2": {
        "id": "control_q2",
        "block": "control",
        "weight": 3,
        "text": "Опишите конкретную ситуацию, когда партнер высказывался о ком-то из ваших друзей или родственников. Что именно он говорил и в какой обстановке?",
        "context": "Вспомните точные слова, которые он использовал. Говорил ли он это вам наедине или при других людях? Какой тон был у разговора?",
        "prompt_hints": [
            "Какие именно слова он использовал о вашем близком человеке",
            "В какой ситуации происходил этот разговор",
            "Какой была его мимика и интонация",
            "Как часто он возвращается к этой теме"
        ],
        "min_length": 50,
        "example": "После встречи с моей подругой он сказал: 'Твоя Катя опять тебя накручивает против меня. Она завидует нашим отношениям.' Говорил это серьезным тоном, глядя мне в глаза. Теперь каждый раз перед встречей с ней он напоминает об этом."
    },
    
    "control_q3": {
        "id": "control_q3",
        "block": "control",
        "weight": 3,
        "text": "Опишите последний случай, когда партнер проверял ваш телефон, соцсети или личные вещи. При каких обстоятельствах это происходило?",
        "context": "Вспомните конкретную ситуацию: что он искал, какие оправдания давал, как вы реагировали, что он нашел или не нашел.",
        "prompt_hints": [
            "В какой момент он взял ваш телефон или заглянул в вещи",
            "Какие слова он сказал, объясняя свои действия",
            "Что конкретно он проверял или искал",
            "Как закончилась эта ситуация"
        ],
        "min_length": 50,
        "example": "Вчера утром, пока я была в душе, он взял мой телефон и читал переписку с коллегами. Когда я вышла, он сказал: 'Просто хотел посмотреть время'. Но я видела, что он листал мессенджер. Потом спросил, кто такой Андрей из рабочего чата."
    },
    
    "control_q4": {
        "id": "control_q4",
        "block": "control",
        "weight": 3,
        "text": "Опишите последнюю ситуацию, когда вы хотели потратить деньги на что-то для себя (одежда, развлечения, подарки). Как партнер отреагировал на эту трату?",
        "context": "Вспомните конкретную покупку: что вы хотели купить, как сообщили об этом партнеру, что он сказал, какие аргументы использовал, смогли ли вы совершить покупку.",
        "prompt_hints": [
            "Что конкретно вы хотели купить и за сколько",
            "Какие первые слова он сказал о вашей трате",
            "Какие аргументы он привел против покупки",
            "Пришлось ли вам отказаться от покупки или скрывать ее"
        ],
        "min_length": 50,
        "example": "Хотела купить платье за 5000 рублей. Когда сказала ему, он ответил: 'Опять тратишь деньги на ерунду'. Начал перечислять наши расходы и говорить, что нужно экономить. В итоге я не купила платье, хотя деньги были мои."
    },
    
    "control_q5": {
        "id": "control_q5",
        "block": "control",
        "weight": 3,
        "text": "Вспомните последний раз, когда вы сказали партнеру 'нет' в ответ на его просьбу или требование. Опишите его реакцию в следующие 10 минут.",
        "context": "Сосредоточьтесь на конкретной ситуации: что он просил, как именно вы отказались, что он сказал и делал сразу после вашего 'нет'.",
        "prompt_hints": [
            "О чем конкретно он просил вас",
            "Какими словами вы отказались",
            "Что он сказал сразу после вашего 'нет'",
            "Продолжал ли он настаивать и как именно"
        ],
        "min_length": 50,
        "example": "Он попросил отменить встречу с сестрой, я сказала 'нет, я не могу'. Он сразу начал: 'Ты меня не любишь, раз выбираешь сестру'. Потом полчаса объяснял, почему его дела важнее. В итоге я все-таки отменила встречу."
    },
    
    "control_q6": {
        "id": "control_q6",
        "block": "control",
        "weight": 3,
        "text": "Опишите ситуацию, когда партнер хотел добиться от вас согласия на что-то важное для него, но вы сомневались. Какие эмоциональные аргументы он использовал?",
        "context": "Вспомните конкретный случай: о чем шла речь, какие слова он говорил, упоминал ли любовь, угрожал ли разрывом, вызывал ли чувство вины.",
        "prompt_hints": [
            "О чем конкретно он просил вас согласиться",
            "Какие слова о любви и отношениях он использовал",
            "Упоминал ли он возможность расставания",
            "Как он пытался вызвать у вас чувство вины"
        ],
        "min_length": 50,
        "example": "Он хотел, чтобы я переехала к нему, а я сомневалась. Сказал: 'Если ты меня действительно любишь, то переедешь'. Потом добавил: 'Может, тебе со мной неинтересно? Тогда зачем мы вместе?' Я почувствовала себя виноватой и согласилась."
    },
    
    # BLOCK 3: GASLIGHTING (5 questions)
    "gaslighting_q1": {
        "id": "gaslighting_q1",
        "block": "gaslighting",
        "weight": 3,
        "text": "Вспомните конкретную ситуацию, когда вы напомнили партнеру о его поступке или словах, а он стал отрицать, что это происходило. Опишите этот разговор.",
        "context": "Сосредоточьтесь на том, что именно вы сказали, как он отреагировал, какие слова использовал для отрицания, как вы себя почувствовали после этого разговора.",
        "prompt_hints": [
            "О каком конкретном событии вы ему напомнили",
            "Какие именно слова он сказал, отрицая это",
            "Как он объяснил, почему вы 'неправильно помните'",
            "Что вы почувствовали после его слов"
        ],
        "min_length": 50,
        "example": "Я напомнила ему, что он вчера кричал на меня из-за посуды. Он сказал: 'Ничего подобного не было, ты все выдумываешь'. Потом добавил: 'У тебя плохая память, я просто попросил помыть тарелки'. Я начала сомневаться в своих воспоминаниях."
    },
    
    "gaslighting_q2": {
        "id": "gaslighting_q2",
        "block": "gaslighting",
        "weight": 3,
        "text": "Опишите момент, когда вы выразили партнеру свои чувства (обиду, грусть, злость) по поводу его поведения. Какой была его первая реакция?",
        "context": "Вспомните конкретную ситуацию: что вы чувствовали, как именно выразили это партнеру, что он ответил в первые 30 секунд, изменилось ли ваше восприятие своих чувств после его слов.",
        "prompt_hints": [
            "Какие чувства вы выразили и какими словами",
            "Что он сказал о ваших чувствах в первые секунды",
            "Как он объяснил, почему вы 'неправильно чувствуете'",
            "Стали ли вы сомневаться в адекватности своих эмоций"
        ],
        "min_length": 50,
        "example": "Я сказала ему, что мне больно из-за его грубых слов. Он сразу ответил: 'Ты слишком чувствительная, я же не со зла'. Потом добавил: 'Нормальные люди не обижаются на такие мелочи'. Я стала думать, что действительно реагирую неправильно."
    },
    
    "gaslighting_q3": {
        "id": "gaslighting_q3",
        "block": "gaslighting",
        "weight": 3,
        "text": "Вспомните ситуацию, когда партнер совершил поступок, который вас расстроил, и вы обратились к нему с этим. Как он объяснил свое поведение?",
        "context": "Сосредоточьтесь на том, признал ли он свою ответственность или переложил вину на вас. Какие именно слова он использовал, чтобы объяснить свои действия.",
        "prompt_hints": [
            "Что конкретно он сделал, что вас расстроило",
            "Признал ли он, что поступил неправильно",
            "Как он объяснил, почему вы виноваты в его поступке",
            "Какие слова он использовал, чтобы переложить ответственность"
        ],
        "min_length": 50,
        "example": "Он опоздал на наш важный ужин на 2 часа. Когда я расстроилась, он сказал: 'Ты меня так нервируешь своими требованиями, что я специально задержался'. Потом добавил: 'Если бы ты не давила на меня, я бы пришел вовремя'."
    },
    
    "gaslighting_q4": {
        "id": "gaslighting_q4",
        "block": "gaslighting",
        "weight": 3,
        "text": "Опишите случай, когда партнер использовал против вас информацию, которой вы с ним поделились в доверительном разговоре. В какой ситуации это произошло?",
        "context": "Вспомните, что именно вы ему рассказывали, в каком контексте он это вспомнил, какие слова использовал, как вы себя почувствовали, когда поняли, что ваши слова обернулись против вас.",
        "prompt_hints": [
            "Какую личную информацию вы ему доверили",
            "В какой ситуации он это против вас использовал",
            "Какие именно слова он сказал, припоминая это",
            "Как изменилось ваше желание делиться с ним после этого"
        ],
        "min_length": 50,
        "example": "Я рассказала ему о своих комплексах по поводу внешности. Через месяц в ссоре он сказал: 'Ты же сама знаешь, что у тебя проблемы с фигурой, так чего ты от меня хочешь?' После этого я перестала ему доверять личное."
    },
    
    "gaslighting_q5": {
        "id": "gaslighting_q5",
        "block": "gaslighting",
        "weight": 3,
        "text": "Вспомните разговор, когда вы сказали партнеру что-то нейтральное или доброе, а он интерпретировал это как нападение или критику. Опишите эту ситуацию.",
        "context": "Сосредоточьтесь на том, что именно вы сказали, какой смысл вы вкладывали, как он это понял, какие мотивы вам приписал, как объяснил свою интерпретацию.",
        "prompt_hints": [
            "Что именно вы сказали и с какой интонацией",
            "Какой смысл он услышал в ваших словах",
            "Какие плохие намерения вам приписал",
            "Как он объяснил, почему понял вас именно так"
        ],
        "min_length": 50,
        "example": "Я сказала: 'Может, сегодня приготовишь ужин?' с улыбкой. Он взорвался: 'Ты намекаешь, что я лентяй! Всегда ищешь повод меня унизить!' Я пыталась объяснить, что просто устала, но он не слушал."
    },
    
    # BLOCK 4: EMOTION (4 questions)
    "emotion_q1": {
        "id": "emotion_q1",
        "block": "emotion",
        "weight": 3,
        "text": "Опишите последний случай, когда партнер сильно разозлился. Что именно он делал и говорил в первые 5 минут своей злости?",
        "context": "Вспомните конкретную ситуацию: что его разозлило, какие физические действия он совершал, какие слова говорил, какой была его мимика и жесты, как долго это продолжалось.",
        "prompt_hints": [
            "Что конкретно вызвало его гнев",
            "Какие физические действия он совершал (жесты, движения)",
            "Какие именно слова он кричал или говорил",
            "Сколько времени длилась его вспышка гнева"
        ],
        "min_length": 50,
        "example": "Он разозлился из-за того, что я забыла купить хлеб. Сразу начал кричать: 'Ты никогда ничего не помнишь!' Ударил кулаком по столу, швырнул свою тарелку. Кричал 10 минут, потом сказал: 'Из-за тебя я стал нервным'."
    },
    
    "emotion_q2": {
        "id": "emotion_q2",
        "block": "emotion",
        "weight": 2,
        "text": "Вспомните день, когда настроение партнера кардинально изменилось. Опишите, как это происходило: что он говорил и делал до и после смены настроения.",
        "context": "Сосредоточьтесь на конкретном дне: каким он был утром, что произошло, что изменило его настроение, как быстро это случилось, каким он стал после изменения.",
        "prompt_hints": [
            "Каким было его настроение в начале дня",
            "Что конкретно спровоцировало изменение",
            "Как быстро произошла смена настроения (минуты, часы)",
            "Как он себя вел после изменения настроения"
        ],
        "min_length": 50,
        "example": "Утром он целовал меня и говорил комплименты. В обед я сказала, что задержусь на работе. За 5 минут он превратился в другого человека: начал кричать, что я его не ценю, потом весь вечер молчал и хлопал дверями."
    },
    
    "emotion_q3": {
        "id": "emotion_q3",
        "block": "emotion",
        "weight": 2,
        "text": "Вспомните ссору, которая произошла между вами месяц назад или раньше. Упоминает ли партнер эту ссору в текущих разговорах? Если да, то как именно?",
        "context": "Сосредоточьтесь на конкретной старой ссоре: о чем она была, как часто он к ней возвращается, какие слова использует, когда припоминает, в каком контексте это происходит.",
        "prompt_hints": [
            "О чем была та старая ссора",
            "Как часто он вспоминает этот конфликт",
            "Какие именно слова он говорит, припоминая это",
            "В каких ситуациях он использует эту старую обиду"
        ],
        "min_length": 50,
        "example": "Месяц назад мы поссорились из-за того, что я опоздала на встречу. Теперь каждый раз, когда я собираюсь куда-то, он говорит: 'Только не опаздывай, как тогда'. Даже в разговорах с друзьями рассказывает эту историю."
    },
    
    "emotion_q4": {
        "id": "emotion_q4",
        "block": "emotion",
        "weight": 2,
        "text": "Опишите последний случай, когда у партнера была стрессовая ситуация (проблемы на работе, конфликт, неудача). Как он себя вел с вами в этот день?",
        "context": "Вспомните конкретную стрессовую ситуацию: что произошло, как он рассказал вам об этом, как изменилось его поведение дома, направил ли он свой стресс на вас.",
        "prompt_hints": [
            "Какая стрессовая ситуация у него произошла",
            "Как он рассказал вам о своих проблемах",
            "Как изменилось его поведение дома после стресса",
            "Стали ли вы объектом его раздражения из-за стресса"
        ],
        "min_length": 50,
        "example": "У него был конфликт с начальником. Пришел домой мрачный, на мой вопрос 'Как дела?' резко ответил: 'Отстань'. Потом весь вечер придирался к мелочам: посуда не так стоит, ужин не такой. Я стала виновата в его рабочих проблемах."
    },
    
    # BLOCK 5: INTIMACY (3 questions)
    "intimacy_q1": {
        "id": "intimacy_q1",
        "block": "intimacy",
        "weight": 3,
        "text": "Вспомните последний раз, когда вы не были готовы к близости и сказали партнеру 'не сейчас' или 'не хочу'. Как именно он отреагировал?",
        "context": "Сосредоточьтесь на конкретной ситуации: что вы сказали, какие слова он использовал в ответ, какие эмоции проявил, как долго длилась его реакция, что произошло дальше.",
        "prompt_hints": [
            "Какими словами вы отказались от близости",
            "Что он сказал в первые секунды после отказа",
            "Какие эмоции он проявил (обиду, злость, понимание)",
            "Как он себя вел с вами в следующие несколько часов"
        ],
        "min_length": 50,
        "example": "Я сказала: 'Прости, я устала, не сегодня'. Он сразу нахмурился и сказал: 'Ты всегда находишь отговорки'. Потом добавил: 'Нормальные женщины не отказывают мужчинам'. Весь вечер демонстративно молчал и отворачивался."
    },
    
    "intimacy_q2": {
        "id": "intimacy_q2",
        "block": "intimacy",
        "weight": 3,
        "text": "Опишите случай, когда вы хотели надеть определенную одежду или сделать что-то с внешностью, а партнер высказал свое мнение. Что именно он сказал?",
        "context": "Вспомните конкретную ситуацию: что вы хотели надеть или как изменить внешность, какие слова он использовал, какой тон был у разговора, изменили ли вы решение после его слов.",
        "prompt_hints": [
            "Что именно вы хотели надеть или сделать с внешностью",
            "Какие конкретные слова он сказал об этом",
            "Какой была его интонация (просьба, требование, запрет)",
            "Изменили ли вы свое решение после его слов"
        ],
        "min_length": 50,
        "example": "Я хотела надеть новое платье на встречу с подругами. Он сказал: 'В этом платье ты выглядишь как... Мужчины будут пялиться'. Потом добавил: 'Если наденешь, значит, хочешь привлекать внимание других'. Я переоделась в джинсы."
    },
    
    "intimacy_q3": {
        "id": "intimacy_q3",
        "block": "intimacy",
        "weight": 2,
        "text": "Вспомните разговор, когда партнер расспрашивал вас о прошлых отношениях или упоминал ваших бывших партнеров. Что именно он говорил и спрашивал?",
        "context": "Сосредоточьтесь на конкретном разговоре: какие вопросы он задавал, какие комментарии делал, сравнивал ли себя с бывшими, какие эмоции проявлял при этом.",
        "prompt_hints": [
            "Какие конкретные вопросы он задавал о прошлом",
            "Какие комментарии делал о ваших бывших партнерах",
            "Сравнивал ли себя с ними и как именно",
            "Какие эмоции он проявлял во время этого разговора"
        ],
        "min_length": 50,
        "example": "Он спросил: 'А твой бывший был лучше меня в постели?' Когда я не ответила, начал сам перечислять: 'Он был выше? Богаче? Умнее?' Потом сказал: 'Я знаю, что ты по нему скучаешь'. Весь разговор был пропитан ревностью."
    },
    
    # BLOCK 6: SOCIAL (4 questions)
    "social_q1": {
        "id": "social_q1",
        "block": "social",
        "weight": 2,
        "text": "Опишите недавнее мероприятие, где вы были с партнером в компании других людей. Как он себя вел с вами при свидетелях и как дома после?",
        "context": "Вспомните конкретное событие: что это было за мероприятие, как он обращался с вами при людях, что говорил, как изменилось его поведение, когда вы остались наедине.",
        "prompt_hints": [
            "Какое это было мероприятие и кто там был",
            "Как он обращался с вами при других людях",
            "Что говорил о вас в компании",
            "Как изменилось его поведение дома после мероприятия"
        ],
        "min_length": 50,
        "example": "На дне рождения у друзей он был очень внимательным: обнимал, приносил еду, говорил комплименты. Все восхищались нашей парой. Но по дороге домой начал критиковать мой наряд и поведение. Дома сказал: 'Ты опозорила меня перед друзьями'."
    },
    
    "social_q2": {
        "id": "social_q2",
        "block": "social",
        "weight": 2,
        "text": "Опишите последний случай, когда вы были с партнером в ресторане, магазине или другом месте обслуживания. Как именно он общался с персоналом?",
        "context": "Вспомните конкретную ситуацию: где вы были, что произошло, какие слова он говорил персоналу, какой тон использовал, как вы себя чувствовали в этот момент.",
        "prompt_hints": [
            "Где именно происходила эта ситуация",
            "Какие слова он говорил обслуживающему персоналу",
            "Какой тон и интонацию он использовал",
            "Как вы себя чувствовали, наблюдая это"
        ],
        "min_length": 50,
        "example": "В ресторане официантка перепутала наш заказ. Он сразу повысил голос: 'Вы что, не умеете работать? Я не буду это есть!' Потом добавил: 'Таких как вы увольнять надо'. Мне было так стыдно, что я извинилась перед девушкой."
    },
    
    "social_q3": {
        "id": "social_q3",
        "block": "social",
        "weight": 2,
        "text": "Вспомните ситуацию, когда кто-то из друзей или знакомых партнера обратился к нему за помощью или поддержкой. Как он отреагировал и что сделал?",
        "context": "Сосредоточьтесь на конкретном случае: кто обратился за помощью, о чем просил, что ответил ваш партнер, помог ли он, какие слова использовал.",
        "prompt_hints": [
            "Кто именно обратился к нему за помощью",
            "О какой помощи или поддержке просили",
            "Что он ответил на просьбу о помощи",
            "Помог ли он в итоге или нашел отговорки"
        ],
        "min_length": 50,
        "example": "Его друг попросил помочь с переездом в выходные. Он сказал: 'У меня свои дела, найди кого-нибудь еще'. Потом добавил: 'Я же не обязан всем помогать'. Хотя весь день просто лежал дома и смотрел телевизор."
    },
    
    "social_q4": {
        "id": "social_q4",
        "block": "social",
        "weight": 2,
        "text": "Опишите, как партнер рассказывает о своих отношениях с коллегами по работе. Что именно он говорит о конкретных людях из своего рабочего окружения?",
        "context": "Вспомните его рассказы о работе: как он описывает коллег, какие слова использует, винит ли их в своих проблемах, как объясняет рабочие конфликты.",
        "prompt_hints": [
            "Как он описывает своих коллег (имена, характеристики)",
            "Винит ли он коллег в своих рабочих проблемах",
            "Как он объясняет конфликты на работе",
            "Считает ли он себя лучше других на работе"
        ],
        "min_length": 50,
        "example": "Он говорит: 'Мой коллега Андрей - полный идиот, только мешает работать'. О начальнике: 'Она меня не понимает, потому что завидует моим способностям'. Любые проблемы на работе объясняет тем, что 'окружен дураками'."
    }
}

# =================================
# БЛОК 1: НАРЦИССИЗМ И ГРАНДИОЗНОСТЬ (6 вопросов - убрал narcissism_q7)
# =================================

NARCISSISM_QUESTIONS = {
    "narcissism_q1": {
        "id": "narcissism_q1",
        "block": "narcissism",
        "weight": 3,  # Высокий вес
        "text": "Как ваш партнер реагирует на критику или замечания?",
        "context": "Оцените типичную реакцию партнера на конструктивную критику",
        "options": [
            "Выслушивает спокойно и благодарит за обратную связь",
            "Может расстроиться, но потом обдумывает сказанное",
            "Защищается и оправдывается, не принимая критику",
            "Раздражается и переходит в контратаку",
            "Агрессивно отвергает критику и обвиняет в ответ"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "narcissism_q2": {
        "id": "narcissism_q2",
        "block": "narcissism",
        "weight": 3,
        "text": "Как ваш партнер относится к чужим успехам?",
        "context": "Реакция на достижения друзей, коллег или вас",
        "options": [
            "Искренне радуется и поздравляет",
            "Поздравляет, но с небольшой завистью",
            "Равнодушен к чужим успехам",
            "Обесценивает достижения или находит недостатки",
            "Злится и считает, что ему везет меньше"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "narcissism_q3": {
        "id": "narcissism_q3",
        "block": "narcissism", 
        "weight": 3,
        "text": "Как ваш партнер описывает себя в разговорах?",
        "context": "Самовосприятие и самопрезентация",
        "options": [
            "Скромно, не выпячивая свои достоинства",
            "Уверенно, но без преувеличений",
            "Иногда преувеличивает свои достижения",
            "Часто подчеркивает свою исключительность",
            "Считает себя лучше большинства людей"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "narcissism_q4": {
        "id": "narcissism_q4",
        "block": "narcissism",
        "weight": 3,
        "text": "Как ваш партнер реагирует на ваши переживания?",
        "context": "Эмпатия к эмоциональным состояниям",
        "options": [
            "Внимательно выслушивает и поддерживает",
            "Старается помочь, но не всегда понимает",
            "Иногда отвлекается, но в целом сочувствует",
            "Слушает невнимательно, быстро переводит тему на себя",
            "Обесценивает переживания или раздражается"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "narcissism_q5": {
        "id": "narcissism_q5",
        "block": "narcissism",
        "weight": 2,
        "text": "Как ваш партнер строит отношения с другими людьми?",
        "context": "Способность к равноправным отношениям",
        "options": [
            "Легко находит общий язык, уважает границы",
            "В целом хорошо, но иногда может быть эгоистичным",
            "Относится к людям в зависимости от настроения",
            "Делит людей на полезных и бесполезных",
            "Использует людей для достижения своих целей"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "narcissism_q6": {
        "id": "narcissism_q6",
        "block": "narcissism",
        "weight": 3,
        "text": "Как ваш партнер извиняется за свои ошибки?",
        "context": "Способность признавать вину и извиняться",
        "options": [
            "Искренне извиняется и старается исправить ситуацию",
            "Извиняется, но иногда с оговорками",
            "Извиняется неохотно, когда его принуждают",
            "Извиняется формально, не признавая вины",
            "Не извиняется, находит оправдания или обвиняет других"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# БЛОК 2: КОНТРОЛЬ И МАНИПУЛЯЦИИ (6 вопросов - убрал control_q6 и control_q8)
# =================================

CONTROL_QUESTIONS = {
    "control_q1": {
        "id": "control_q1",
        "block": "control",
        "weight": 4,
        "text": "Как ваш партнер реагирует на ваши планы встретиться с друзьями?",
        "context": "Контроль социальных контактов",
        "options": [
            "Поддерживает и радуется за меня",
            "Нейтрально, иногда интересуется планами",
            "Иногда выражает недовольство, но не запрещает",
            "Часто недоволен, устраивает сцены",
            "Категорически против, запрещает встречи"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "control_q2": {
        "id": "control_q2",
        "block": "control",
        "weight": 3,
        "text": "Как партнер относится к вашим личным вещам и пространству?",
        "context": "Уважение к личным границам",
        "options": [
            "Полностью уважает мои границы",
            "В основном уважает, иногда может нарушить",
            "Периодически роется в вещах без разрешения",
            "Часто проверяет телефон, сообщения",
            "Постоянно контролирует все мои вещи и действия"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "control_q3": {
        "id": "control_q3",
        "block": "control",
        "weight": 4,
        "text": "Как ваш партнер реагирует на ваши успехи и достижения?",
        "context": "Отношение к независимости партнера",
        "options": [
            "Искренне радуется и поддерживает",
            "Радуется, но иногда может приревновать",
            "Реагирует нейтрально, без особого интереса",
            "Обесценивает или находит недостатки",
            "Злится, пытается помешать моим успехам"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "control_q4": {
        "id": "control_q4",
        "block": "control",
        "weight": 3,
        "text": "Как происходят ваши совместные решения?",
        "context": "Демократичность в принятии решений",
        "options": [
            "Всегда обсуждаем и принимаем решения вместе",
            "Обычно советуемся, но иногда один решает сам",
            "Часто один из нас навязывает свое мнение",
            "Партнер принимает большинство решений единолично",
            "Партнер решает все, мое мнение не учитывается"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "control_q5": {
        "id": "control_q5",
        "block": "control",
        "weight": 4,
        "text": "Как ваш партнер реагирует на ваши самостоятельные решения?",
        "context": "Толерантность к автономии",
        "options": [
            "Поддерживает мою самостоятельность",
            "В основном поддерживает, иногда может не согласиться",
            "Часто требует отчета о моих решениях",
            "Злится, если я что-то решаю без него",
            "Запрещает принимать решения самостоятельно"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "control_q6": {
        "id": "control_q6",
        "block": "control",
        "weight": 3,
        "text": "Как ваш партнер относится к вашим увлечениям и хобби?",
        "context": "Поддержка личных интересов",
        "options": [
            "Активно поддерживает и интересуется",
            "Относится нейтрально, не мешает",
            "Иногда критикует, но в целом терпит",
            "Часто обесценивает, называет пустой тратой времени",
            "Запрещает заниматься тем, что мне нравится"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# БЛОК 3: ГАЗЛАЙТИНГ И ИСКАЖЕНИЕ РЕАЛЬНОСТИ (5 вопросов - убрал gaslighting_q5)
# =================================

GASLIGHTING_QUESTIONS = {
    "gaslighting_q1": {
        "id": "gaslighting_q1",
        "block": "gaslighting",
        "weight": 4,
        "text": "Как ваш партнер реагирует, когда вы выражаете свои чувства?",
        "context": "Валидация эмоций",
        "options": [
            "Внимательно выслушивает и принимает",
            "Старается понять, иногда может не согласиться",
            "Иногда обесценивает, но в целом слушает",
            "Часто говорит, что я слишком чувствительна",
            "Полностью отрицает мои чувства и называет их неправильными"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "gaslighting_q2": {
        "id": "gaslighting_q2",
        "block": "gaslighting",
        "weight": 4,
        "text": "Как ваш партнер ведет себя после конфликтов?",
        "context": "Отношение к разрешению конфликтов",
        "options": [
            "Обсуждает произошедшее и ищет решение",
            "Обычно мирится, но не всегда обсуждает проблему",
            "Делает вид, что ничего не произошло",
            "Обвиняет меня в том, что я все придумала",
            "Утверждает, что конфликта не было, я все выдумала"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "gaslighting_q3": {
        "id": "gaslighting_q3",
        "block": "gaslighting",
        "weight": 3,
        "text": "Как ваш партнер относится к вашей памяти о событиях?",
        "context": "Подрыв доверия к собственной памяти",
        "options": [
            "Доверяет моей памяти и версии событий",
            "Иногда может не согласиться, но уважает мою точку зрения",
            "Периодически сомневается в моей памяти",
            "Часто утверждает, что я все неправильно помню",
            "Постоянно говорит, что у меня плохая память и я все путаю"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "gaslighting_q4": {
        "id": "gaslighting_q4",
        "block": "gaslighting",
        "weight": 4,
        "text": "Как ваш партнер реагирует на ваши сомнения в отношениях?",
        "context": "Реакция на выражение сомнений",
        "options": [
            "Открыто обсуждает и старается разобраться",
            "Выслушивает, но может защищаться",
            "Иногда раздражается, но в целом слушает",
            "Обвиняет меня в паранойе и недоверии",
            "Говорит, что я сумасшедшая и все выдумываю"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "gaslighting_q5": {
        "id": "gaslighting_q5",
        "block": "gaslighting",
        "weight": 3,
        "text": "Как ваш партнер объясняет свои противоречивые действия?",
        "context": "Способность признавать непоследовательность",
        "options": [
            "Честно объясняет и признает противоречия",
            "Обычно находит логичное объяснение",
            "Иногда уходит от ответа или меняет тему",
            "Отрицает противоречия и обвиняет меня в придирках",
            "Утверждает, что противоречий нет, я все неправильно понимаю"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# БЛОК 4: ЭМОЦИОНАЛЬНАЯ РЕГУЛЯЦИЯ (4 вопроса - убрал emotion_q3) 
# =================================

EMOTION_QUESTIONS = {
    "emotion_q1": {
        "id": "emotion_q1",
        "block": "emotion",
        "weight": 4,
        "text": "Как ваш партнер выражает гнев?",
        "context": "Способы выражения негативных эмоций",
        "options": [
            "Спокойно обсуждает то, что его расстроило",
            "Иногда повышает голос, но быстро успокаивается",
            "Часто кричит, но не переходит на личности",
            "Оскорбляет, унижает, может бросать вещи",
            "Применяет физическую силу или угрожает"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "emotion_q2": {
        "id": "emotion_q2",
        "block": "emotion",
        "weight": 3,
        "text": "Как часто у вашего партнера меняется настроение?",
        "context": "Эмоциональная стабильность",
        "options": [
            "Настроение стабильное, изменения предсказуемы",
            "Иногда бывают перепады, но в целом стабильно",
            "Настроение меняется довольно часто",
            "Резкие перепады настроения несколько раз в неделю",
            "Настроение меняется несколько раз в день непредсказуемо"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "emotion_q3": {
        "id": "emotion_q3",
        "block": "emotion",
        "weight": 4,
        "text": "Как ваш партнер реагирует на ваши слезы или расстройство?",
        "context": "Эмпатия к эмоциональному состоянию",
        "options": [
            "Утешает и поддерживает",
            "Старается помочь, но иногда не знает как",
            "Иногда игнорирует, иногда утешает",
            "Раздражается и говорит перестать плакать",
            "Злится, оскорбляет или обвиняет в слабости"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "emotion_q4": {
        "id": "emotion_q4",
        "block": "emotion",
        "weight": 3,
        "text": "Как ваш партнер ведет себя в стрессовых ситуациях?",
        "context": "Поведение под давлением",
        "options": [
            "Остается спокойным и рациональным",
            "Иногда нервничает, но в целом справляется",
            "Часто теряет самообладание, но не срывается на других",
            "Становится агрессивным, винит окружающих",
            "Полностью теряет контроль, может стать опасным"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# БЛОК 5: ИНТИМНОСТЬ И ПРИНУЖДЕНИЕ (3 вопроса - убрал intimacy_q3)
# =================================

INTIMACY_QUESTIONS = {
    "intimacy_q1": {
        "id": "intimacy_q1",
        "block": "intimacy",
        "weight": 4,
        "text": "Как ваш партнер относится к вашим границам в интимности?",
        "context": "Уважение к согласию и границам",
        "options": [
            "Всегда спрашивает согласие и уважает границы",
            "Обычно уважает, иногда может настаивать",
            "Иногда игнорирует нежелание, но останавливается",
            "Часто принуждает и не принимает отказ",
            "Полностью игнорирует согласие и применяет принуждение"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "intimacy_q2": {
        "id": "intimacy_q2",
        "block": "intimacy",
        "weight": 3,
        "text": "Как ваш партнер реагирует на ваши потребности в близости?",
        "context": "Внимание к потребностям партнера",
        "options": [
            "Внимательно выслушивает и учитывает мои потребности",
            "Старается понять, но не всегда получается",
            "Иногда учитывает, иногда фокусируется только на себе",
            "Редко интересуется моими потребностями",
            "Полностью игнорирует мои потребности и желания"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "intimacy_q3": {
        "id": "intimacy_q3",
        "block": "intimacy",
        "weight": 4,
        "text": "Использует ли ваш партнер интимность для контроля?",
        "context": "Манипуляции через интимность",
        "options": [
            "Никогда не использует интимность для манипуляций",
            "Очень редко может намекать на связь между близостью и отношениями",
            "Иногда обижается при отказе в близости",
            "Часто угрожает разрывом при отказе в близости",
            "Постоянно шантажирует и принуждает через угрозы"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# БЛОК 6: СОЦИАЛЬНОЕ ПОВЕДЕНИЕ (4 вопроса - без изменений)
# =================================

SOCIAL_QUESTIONS = {
    "social_q1": {
        "id": "social_q1",
        "block": "social",
        "weight": 3,
        "text": "Как ваш партнер ведет себя в компании других людей?",
        "context": "Социальное поведение и маски",
        "options": [
            "Ведет себя естественно, так же как наедине",
            "Иногда может быть более сдержанным или активным",
            "Заметно меняется в компании, но не кардинально",
            "Кардинально меняется, становится другим человеком",
            "Полностью другая личность, неузнаваемый"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "social_q2": {
        "id": "social_q2",
        "block": "social",
        "weight": 4,
        "text": "Как ваш партнер относится к вашим друзьям и семье?",
        "context": "Изоляция от поддерживающего окружения",
        "options": [
            "Поддерживает ваши отношения с близкими",
            "В целом нормально, но не все друзья ему нравятся",
            "Иногда критикует близких, но не запрещает общение",
            "Часто критикует ваших друзей и ограничивает общение",
            "Запрещает видеться с друзьями и семьей"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "social_q3": {
        "id": "social_q3",
        "block": "social",
        "weight": 3,
        "text": "Как окружающие относятся к вашему партнеру?",
        "context": "Восприятие партнера другими людьми",
        "options": [
            "Все друзья и семья его любят и уважают",
            "Большинство относится хорошо, есть нейтральные",
            "Отношение смешанное, есть как положительные, так и негативные мнения",
            "Многие высказывают сомнения или не одобряют",
            "Почти все предупреждают меня о нем"
        ],
        "weights": [0, 1, 2, 3, 4]
    },
    
    "social_q4": {
        "id": "social_q4",
        "block": "social",
        "weight": 4,
        "text": "Как ваш партнер реагирует на критику от других?",
        "context": "Реакция на внешнюю критику",
        "options": [
            "Выслушивает и анализирует критику",
            "Иногда защищается, но в целом принимает",
            "Часто обижается, но не мстит",
            "Злится и пытается отомстить критикам",
            "Впадает в ярость, может стать опасным"
        ],
        "weights": [0, 1, 2, 3, 4]
    }
}

# =================================
# ОСНОВНЫЕ ФУНКЦИИ
# =================================

def get_all_questions() -> Dict[str, Dict[str, Any]]:
    """Получить все вопросы профайлера"""
    all_questions = {}
    all_questions.update(NARCISSISM_QUESTIONS)
    all_questions.update(CONTROL_QUESTIONS)
    all_questions.update(GASLIGHTING_QUESTIONS)
    all_questions.update(EMOTION_QUESTIONS)
    all_questions.update(INTIMACY_QUESTIONS)
    all_questions.update(SOCIAL_QUESTIONS)
    return all_questions

def get_free_form_questions() -> Dict[str, Dict[str, Any]]:
    """Получить вопросы в свободной форме (экспериментальная версия)"""
    return FREE_FORM_QUESTIONS.copy()

def is_free_form_question(question_id: str) -> bool:
    """Проверить, является ли вопрос в свободной форме"""
    return question_id in FREE_FORM_QUESTIONS

def get_question_by_state(state_name: str) -> Dict[str, Any]:
    """Получить вопрос по имени состояния"""
    questions = get_all_questions()
    return questions.get(state_name)

def get_block_questions(block_name: str) -> Dict[str, Dict[str, Any]]:
    """Получить все вопросы блока"""
    all_questions = get_all_questions()
    return {k: v for k, v in all_questions.items() if v['block'] == block_name}

def calculate_total_questions() -> int:
    """Подсчитать общее количество вопросов"""
    return len(get_all_questions())

# =================================
# НАВИГАЦИЯ ПО ВОПРОСАМ (ОБНОВЛЕННАЯ ДЛЯ 28 ВОПРОСОВ)
# =================================

QUESTION_ORDER = [
    # Block 1: Narcissism (6 questions)
    "narcissism_q1", "narcissism_q2", "narcissism_q3", "narcissism_q4",
    "narcissism_q5", "narcissism_q6",
    
    # Block 2: Control (6 questions)  
    "control_q1", "control_q2", "control_q3", "control_q4",
    "control_q5", "control_q6",
    
    # Block 3: Gaslighting (5 questions)
    "gaslighting_q1", "gaslighting_q2", "gaslighting_q3", 
    "gaslighting_q4", "gaslighting_q5",
    
    # Block 4: Emotion (4 questions)
    "emotion_q1", "emotion_q2", "emotion_q3", "emotion_q4",
    
    # Block 5: Intimacy (3 questions)
    "intimacy_q1", "intimacy_q2", "intimacy_q3",
    
    # Block 6: Social (4 questions)
    "social_q1", "social_q2", "social_q3", "social_q4"
]

def get_next_question_state(current_state: str) -> str:
    """Получить следующее состояние вопроса"""
    try:
        current_index = QUESTION_ORDER.index(current_state)
        if current_index < len(QUESTION_ORDER) - 1:
            return QUESTION_ORDER[current_index + 1]
        else:
            return "reviewing_answers"
    except ValueError:
        return "reviewing_answers"

def get_previous_question_state(current_state: str) -> str:
    """Получить предыдущее состояние вопроса"""
    try:
        current_index = QUESTION_ORDER.index(current_state)
        if current_index > 0:
            return QUESTION_ORDER[current_index - 1]
        else:
            return "waiting_for_description"
    except ValueError:
        return "waiting_for_description"

def get_question_progress(current_state: str) -> Tuple[int, int]:
    """Получить прогресс прохождения (текущий вопрос, общее количество)"""
    try:
        current_index = QUESTION_ORDER.index(current_state)
        return (current_index + 1, len(QUESTION_ORDER))
    except ValueError:
        return (1, len(QUESTION_ORDER))

def get_block_by_question(question_state: str) -> str:
    """Получить блок по состоянию вопроса"""
    question = get_question_by_state(question_state)
    return question.get('block', 'unknown') if question else 'unknown'

def format_question_text(question_data: Dict[str, Any], question_num: int, total_questions: int) -> str:
    """Форматировать текст вопроса для отображения"""
    if not question_data:
        return "Ошибка: вопрос не найден"
    
    # Блок эмодзи
    block_emoji = {
        "narcissism": "🧠",
        "control": "🎯", 
        "gaslighting": "🔄",
        "emotion": "💭",
        "intimacy": "💕",
        "social": "👥"
    }
    
    block_names = {
        "narcissism": "Нарциссизм и грандиозность",
        "control": "Контроль и манипуляции",
        "gaslighting": "Газлайтинг и искажение реальности", 
        "emotion": "Эмоциональная регуляция",
        "intimacy": "Интимность и принуждение",
        "social": "Социальное поведение"
    }
    
    block = question_data.get('block', 'unknown')
    emoji = block_emoji.get(block, '❓')
    block_name = block_names.get(block, 'Неизвестный блок')
    
    # Прогресс-бар
    progress_percentage = (question_num / total_questions) * 100
    progress_bar_length = 10
    filled_length = int(progress_bar_length * question_num // total_questions)
    progress_bar = "█" * filled_length + "░" * (progress_bar_length - filled_length)
    
    question_text = f"""📋 **Вопрос {question_num} из {total_questions}**

{emoji} **Блок:** {block_name}

📊 **Прогресс:** {progress_bar} {progress_percentage:.0f}%

❓ **{question_data['text']}**

💭 _{question_data['context']}_

Выберите наиболее подходящий вариант:"""
    
    return question_text

# =================================
# СИСТЕМА ПОДСЧЕТА БАЛЛОВ
# =================================

def calculate_weighted_scores(answers: Dict[str, int]) -> Dict[str, Any]:
    """Подсчитать взвешенные баллы с учетом весов вопросов"""
    all_questions = get_all_questions()
    
    # Подсчет по блокам
    block_scores = {
        "narcissism": 0,
        "control": 0, 
        "gaslighting": 0,
        "emotion": 0,
        "intimacy": 0,
        "social": 0
    }
    
    block_max_scores = {
        "narcissism": 0,
        "control": 0,
        "gaslighting": 0, 
        "emotion": 0,
        "intimacy": 0,
        "social": 0
    }
    
    # Подсчет баллов для каждого ответа
    for question_id, answer_index in answers.items():
        question = all_questions.get(question_id)
        if not question:
            continue
            
        block = question['block']
        weight = question['weight']
        answer_weight = question['weights'][answer_index] if answer_index < len(question['weights']) else 0
        
        # Баллы = вес вопроса * вес ответа
        score = weight * answer_weight
        block_scores[block] += score
        
        # Максимальный возможный балл для этого вопроса
        max_score = weight * max(question['weights'])
        block_max_scores[block] += max_score
    
    # Нормализация баллов до 0-10 по каждому блоку
    normalized_block_scores = {}
    for block in block_scores:
        if block_max_scores[block] > 0:
            normalized_score = (block_scores[block] / block_max_scores[block]) * 10
            normalized_block_scores[block] = round(normalized_score, 1)
        else:
            normalized_block_scores[block] = 0.0
    
    # Общий взвешенный балл риска
    total_score = sum(block_scores.values())
    total_max_score = sum(block_max_scores.values())
    overall_risk_score = (total_score / total_max_score * 100) if total_max_score > 0 else 0
    
    return {
        "block_scores": normalized_block_scores,
        "overall_risk_score": round(overall_risk_score, 1),
        "urgency_level": get_urgency_level(overall_risk_score),
        "raw_scores": block_scores,
        "max_scores": block_max_scores
    }

def get_urgency_level(risk_score: float) -> UrgencyLevel:
    """Определить уровень срочности по баллу риска"""
    if risk_score >= 75:
        return UrgencyLevel.CRITICAL
    elif risk_score >= 50:
        return UrgencyLevel.HIGH
    elif risk_score >= 25:
        return UrgencyLevel.MEDIUM
    else:
        return UrgencyLevel.LOW

def get_safety_alerts(answers: Dict[str, int]) -> List[str]:
    """Генерировать предупреждения безопасности на основе критических ответов"""
    alerts = []
    all_questions = get_all_questions()
    
    # Критические паттерны для немедленного реагирования
    critical_patterns = {
        "control_q1": [3],  # Контроль времени - последний ответ
        "control_q2": [3],  # Изоляция от друзей/семьи
        "control_q4": [3],  # Полный финансовый контроль
        "control_q5": [3],  # Агрессивное нарушение границ
        "control_q7": [3],  # Угрозы и запугивание
        "gaslighting_q1": [3],  # Постоянное отрицание реальности
        "gaslighting_q2": [3],  # Обесценивание чувств
        "gaslighting_q3": [3],  # Никогда не берет вину на себя
        "emotion_q1": [3],  # Вспышки ярости с угрозами
        "intimacy_q1": [3],  # Принуждение в интимности
        "social_q1": [3]   # Кардинально разное поведение дома/на публике
    }
    
    alert_messages = {
        "control_q1": "⚠️ КОНТРОЛЬ ВРЕМЕНИ: Партнер контролирует каждый ваш шаг",
        "control_q2": "⚠️ ИЗОЛЯЦИЯ: Партнер изолирует вас от поддерживающего окружения",
        "control_q4": "⚠️ ФИНАНСОВОЕ ПРИНУЖДЕНИЕ: Полный контроль над вашими деньгами",
        "control_q5": "⚠️ НАРУШЕНИЕ ГРАНИЦ: Агрессивная реакция на ваши границы",
        "control_q7": "🚨 УГРОЗЫ: Партнер использует запугивание и угрозы",
        "gaslighting_q1": "🚨 ГАЗЛАЙТИНГ: Систематическое искажение реальности",
        "gaslighting_q2": "⚠️ ЭМОЦИОНАЛЬНОЕ НАСИЛИЕ: Обесценивание ваших чувств",
        "gaslighting_q3": "⚠️ ОТСУТСТВИЕ ОТВЕТСТВЕННОСТИ: Никогда не признает вину",
        "emotion_q1": "🚨 ФИЗИЧЕСКАЯ УГРОЗА: Неконтролируемые вспышки ярости",
        "intimacy_q1": "🚨 ПРИНУЖДЕНИЕ: Игнорирование согласия в интимности",
        "social_q1": "⚠️ ДВОЙНАЯ ЛИЧНОСТЬ: Кардинально разное поведение"
    }
    
    for question_id, critical_answers in critical_patterns.items():
        answer_index = answers.get(question_id)
        if answer_index in critical_answers:
            alert = alert_messages.get(question_id)
            if alert:
                alerts.append(alert)
    
    return alerts

def validate_full_answers(answers: Dict[str, int]) -> Tuple[bool, str]:
    """Валидировать полный набор ответов"""
    expected_questions = set(QUESTION_ORDER)
    provided_questions = set(answers.keys())
    
    if len(provided_questions) != len(expected_questions):
        missing = expected_questions - provided_questions
        if missing:
            return False, f"Отсутствуют ответы на вопросы: {', '.join(missing)}"
        
    # Проверка валидности ответов
    all_questions = get_all_questions()
    for question_id, answer_index in answers.items():
        question = all_questions.get(question_id)
        if not question:
            return False, f"Неизвестный вопрос: {question_id}"
            
        if not isinstance(answer_index, int) or answer_index < 0 or answer_index >= len(question['options']):
            return False, f"Некорректный ответ для вопроса {question_id}: {answer_index}"
    
    return True, "Все ответы валидны" 