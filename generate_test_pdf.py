#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ PDF —Ñ–∞–π–ª–∞
"""

import asyncio
import os
import sys
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '.'))

from app.services.ai_service import AIService
from app.services.html_pdf_service import HTMLPDFService

async def generate_test_pdf():
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π PDF —Ñ–∞–π–ª"""
    print("üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ PDF...")
    
    # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
    ai_service = AIService()
    html_service = HTMLPDFService()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    test_answers = [
        {
            'question': '–û–ø–∏—à–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏, –∫–æ–≥–¥–∞ –≤—ã –¥–∞–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö',
            'answer': '–ù–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ —è —Å–∫–∞–∑–∞–ª–∞ –µ–º—É —á—Ç–æ –æ–Ω —Å–ª–∏—à–∫–æ–º –≥—Ä—É–±–æ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç —Å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º–∏ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –û–Ω —Å—Ä–∞–∑—É –≤–∑–æ—Ä–≤–∞–ª—Å—è, –Ω–∞—á–∞–ª –∫—Ä–∏—á–∞—Ç—å —á—Ç–æ —è –≤—Å–µ–≥–¥–∞ –µ–≥–æ –∫—Ä–∏—Ç–∏–∫—É—é –∏ —á—Ç–æ –æ–Ω –ø—Ä–æ—Å—Ç–æ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫ —Å–µ—Ä–≤–∏—Å—É. –ü–æ—Ç–æ–º –≤–µ—Å—å –≤–µ—á–µ—Ä –º–æ–ª—á–∞–ª –∏ –≥–æ–≤–æ—Ä–∏–ª —á—Ç–æ —è –µ–≥–æ —É–Ω–∏–∂–∞—é –Ω–∞ –ª—é–¥—è—Ö.',
            'block': 'narcissism'
        },
        {
            'question': '–í—Å–ø–æ–º–Ω–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –≤—ã —Å–∫–∞–∑–∞–ª–∏ "–Ω–µ—Ç" –Ω–∞ –ø—Ä–æ—Å—å–±—É –ø–∞—Ä—Ç–Ω–µ—Ä–∞. –û–ø–∏—à–∏—Ç–µ –µ–≥–æ —Ä–µ–∞–∫—Ü–∏—é –≤ —Å–ª–µ–¥—É—é—â–∏–µ 10 –º–∏–Ω—É—Ç',
            'answer': '–ü–æ–∑–∞–≤—á–µ—Ä–∞ —è –æ—Ç–∫–∞–∑–∞–ª–∞—Å—å –µ—Ö–∞—Ç—å –∫ –µ–≥–æ –¥—Ä—É–∑—å—è–º –Ω–∞ –¥–∞—á—É, —Å–∫–∞–∑–∞–ª–∞ —á—Ç–æ —É—Å—Ç–∞–ª–∞ –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã. –ü–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç –æ–Ω –≥–æ–≤–æ—Ä–∏–ª "–Ω—É –ª–∞–¥–Ω–æ", –Ω–æ –ø–æ—Ç–æ–º –Ω–∞—á–∞–ª: "–¢—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö–æ—á–µ—à—å —Å –º–æ–∏–º–∏ –¥—Ä—É–∑—å—è–º–∏", "–¢—ã —ç–≥–æ–∏—Å—Ç–∫–∞", "–í—Å–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–µ–≤—É—à–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø–∞—Ä–Ω—è". –ü–æ—Ç–æ–º —É—à–µ–ª —Ö–ª–æ–ø–Ω—É–≤ –¥–≤–µ—Ä—å—é.',
            'block': 'control'
        },
        {
            'question': '–í—Å–ø–æ–º–Ω–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∫–æ–≥–¥–∞ –≤—ã –Ω–∞–ø–æ–º–Ω–∏–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—É –æ –µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–∏ –∏–ª–∏ —Å–ª–æ–≤–∞—Ö, –∞ –æ–Ω –æ—Ç—Ä–∏—Ü–∞–ª —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ',
            'answer': '–ú–µ—Å—è—Ü –Ω–∞–∑–∞–¥ –æ–Ω –æ–±–µ—â–∞–ª —á—Ç–æ –º—ã –ø–æ–µ–¥–µ–º –∫ –º–æ–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ. –ö–æ–≥–¥–∞ —è –Ω–∞–ø–æ–º–Ω–∏–ª–∞, –æ–Ω —Å–∫–∞–∑–∞–ª "–Ø —Ç–∞–∫–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª, —Ç—ã –≤—ã–¥—É–º—ã–≤–∞–µ—à—å". –Ø —Ç–æ—á–Ω–æ –ø–æ–º–Ω—é —ç—Ç–æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä, –º—ã –¥–∞–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏ —á—Ç–æ –ø—Ä–∏–≤–µ–∑—Ç–∏. –ù–æ –æ–Ω –Ω–∞—Å—Ç–∞–∏–≤–∞–ª —á—Ç–æ —è –≤—Å–µ –ø—Ä–∏–¥—É–º–∞–ª–∞ –∏ —á—Ç–æ —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é.',
            'block': 'gaslighting'
        },
        {
            'question': '–û–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª—É—á–∞–π –∫–æ–≥–¥–∞ –≤–∞—à –ø–∞—Ä—Ç–Ω–µ—Ä –æ—á–µ–Ω—å —Ä–∞–∑–æ–∑–ª–∏–ª—Å—è. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω –¥–µ–ª–∞–ª –∏ –≥–æ–≤–æ—Ä–∏–ª –≤ –ø–µ—Ä–≤—ã–µ 5 –º–∏–Ω—É—Ç?',
            'answer': '–¢—Ä–∏ –¥–Ω—è –Ω–∞–∑–∞–¥ —Ä–∞–∑–æ–∑–ª–∏–ª—Å—è –∏–∑-–∑–∞ —Ç–æ–≥–æ —á—Ç–æ —è –Ω–µ —Å—Ä–∞–∑—É –æ—Ç–≤–µ—Ç–∏–ª–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±—ã–ª–∞ –≤ –¥—É—à–µ). –ü–µ—Ä–≤—ã–µ 5 –º–∏–Ω—É—Ç –∫—Ä–∏—á–∞–ª: "–ì–¥–µ —Ç—ã –±—ã–ª–∞?!", "–° –∫–µ–º –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∞—Å—å?!", "–¢—ã –º–µ–Ω—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å!". –ë—Ä–æ—Å–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω, —Ö–ª–æ–ø–∞–ª –¥–≤–µ—Ä—Ü–∞–º–∏ —à–∫–∞—Ñ–∞. –õ–∏—Ü–æ –∫—Ä–∞—Å–Ω–æ–µ, –≥–æ–≤–æ—Ä–∏–ª –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –∏ –≥—Ä–æ–º–∫–æ.',
            'block': 'emotions'
        },
        {
            'question': '–û–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–∏—Ç—É–∞—Ü–∏—é –∫–æ–≥–¥–∞ –≤—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –±–ª–∏–∑–æ—Å—Ç–∏. –ö–∞–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –ø–∞—Ä—Ç–Ω–µ—Ä?',
            'answer': '–ù–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ —è —Å–∫–∞–∑–∞–ª–∞ —á—Ç–æ –Ω–µ –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –±–æ–ª–µ–ª–∞ –≥–æ–ª–æ–≤–∞. –û–Ω —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—á–∞–ª —É–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å "–Ω—É –ø–æ–∂–∞–ª—É–π—Å—Ç–∞", –ø–æ—Ç–æ–º —Å–∫–∞–∑–∞–ª "–¢—ã –º–µ–Ω—è –Ω–µ –ª—é–±–∏—à—å", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã –∑–∞–Ω–∏–º–∞—é—Ç—Å—è —ç—Ç–∏–º —á–∞—â–µ", "–ú–æ–∂–µ—Ç —É —Ç–µ–±—è –∫—Ç–æ-—Ç–æ –µ—Å—Ç—å?". –ü–æ—Ç–æ–º –æ–±–∏–¥–µ–ª—Å—è –∏ –Ω–µ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–ª –¥–≤–∞ –¥–Ω—è.',
            'block': 'intimacy'
        },
        {
            'question': '–û–ø–∏—à–∏—Ç–µ –Ω–µ–¥–∞–≤–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ –≥–¥–µ –≤—ã –±—ã–ª–∏ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π. –ö–∞–∫ –æ–Ω –≤–µ–ª —Å–µ–±—è —Å –≤–∞–º–∏ –ø—Ä–∏ —Å–≤–∏–¥–µ—Ç–µ–ª—è—Ö vs –¥–æ–º–∞ –ø–æ—Å–ª–µ?',
            'answer': '–ù–∞ –¥–Ω–µ —Ä–æ–∂–¥–µ–Ω–∏—è —É –ø–æ–¥—Ä—É–≥–∏ –æ–Ω –±—ã–ª –æ—á–µ–Ω—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π, –æ–±–Ω–∏–º–∞–ª, –≥–æ–≤–æ—Ä–∏–ª –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã, –≤—Å–µ –≥–æ–≤–æ—Ä–∏–ª–∏ –∫–∞–∫–æ–π –æ–Ω –∑–∞–±–æ—Ç–ª–∏–≤—ã–π. –ê –¥–æ–º–∞ —Å—Ä–∞–∑—É –∏–∑–º–µ–Ω–∏–ª—Å—è: "–ó–∞—á–µ–º —Ç—ã —Ç–∞–∫ –º–Ω–æ–≥–æ –µ–ª–∞?", "–¢–≤–æ—è –ø–æ–¥—Ä—É–≥–∞ —Å—Ç—Ä–∞–Ω–Ω–∞—è", "–¢—ã —Å–ª–∏—à–∫–æ–º –≥—Ä–æ–º–∫–æ —Å–º–µ—è–ª–∞—Å—å". –ö–∞–∫ –±—É–¥—Ç–æ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —á–µ–ª–æ–≤–µ–∫–∞.',
            'block': 'social'
        }
    ]
    
    try:
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
        print("üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º AI –∞–Ω–∞–ª–∏–∑...")
        result = await ai_service.profile_partner_free_form(
            text_answers=test_answers,
            user_id=12345,
            partner_name="–î–º–∏—Ç—Ä–∏–π",
            partner_description="–ú–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä, 29 –ª–µ—Ç",
            partner_basic_info="29 –ª–µ—Ç, —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º, –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è 1.5 –≥–æ–¥–∞"
        )
        
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤! –†–∏—Å–∫: {result.get('overall_risk_score', 0)}%")
        print(f"üîç –¢–∏–ø: {result.get('personality_type', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
        print("üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF –æ—Ç—á–µ—Ç...")
        pdf_bytes = await html_service.generate_partner_report_html(
            result,
            12345,
            "–î–º–∏—Ç—Ä–∏–π"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"test_report_{timestamp}.pdf"
        
        with open(filename, 'wb') as f:
            f.write(pdf_bytes)
        
        print(f"‚úÖ PDF —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {filename}")
        print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(pdf_bytes)} –±–∞–π—Ç")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞
        profile = result.get('psychological_profile', '')
        print("\nüìù –ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞:")
        print("-" * 60)
        print(profile[:800] + "..." if len(profile) > 800 else profile)
        print("-" * 60)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç —Ä–µ—à–µ—Ç–æ–∫
        if '##' in profile:
            print("‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω—ã —Ä–µ—à–µ—Ç–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ!")
        else:
            print("‚úÖ –¢–µ–∫—Å—Ç –±–µ–∑ —Ä–µ—à–µ—Ç–æ–∫ - –æ—Ç–ª–∏—á–Ω–æ!")
            
        return filename
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return None

if __name__ == "__main__":
    filename = asyncio.run(generate_test_pdf())
    if filename:
        print(f"\nüéâ –ì–æ—Ç–æ–≤–æ! –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª {filename} –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞") 